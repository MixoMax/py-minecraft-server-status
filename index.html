<!DOCTYPE html>
<html>
<head>
  <title>Statistics Backend</title>
  <style>
    /* Add some basic styling to make the graph look nicer */
    body {
      font-family: Arial, sans-serif;
    }
    #graph {
      width: 800px;
      height: 400px;
      border: 1px solid #ccc;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <h1>Statistics Backend</h1>

  <div id = "inputs">
    <input type = "date" id = "start_date" name = "start_date">
    <input type = "date" id = "end_date" name = "end_date">
    <button id = "submit" onclick = "get_data()">Submit</button>
  </div>

  <div id = "graph"></div>

  <script>

    function get_data() {
        var start_date = document.getElementById("start_date").value;
        var end_date = document.getElementById("end_date").value;

        if (start_date == "" || end_date == "") {
            alert("Please enter both start and end dates");
            return;
        }
    
        // convert to YYYY-MM-DD HH:MM format
        start_date = start_date + " 00:00";
        end_date = end_date + " 23:59";

        // make a request to the server
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/api/v1/get_stats?t_start=" + start_date + "&t_end=" + end_date, true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var data = JSON.parse(xhr.responseText);
                console.log(data);
                draw_graph(data);
            }
        }

        xhr.send();
    }

    function draw_graph(data) {
        x_start = data.min_timestamp;
        x_end = data.max_timestamp;
        y_start = data.min_n_players;
        y_end = data.max_n_players + 1;

        // data: [timestamp: int, n_players: int, n_max_players: int (ignore), players_ list[str]]
        // example: [1612345678, 3, 4, ["player1", "player2", "player3"]]

        // convert all values to the range [0, 1]
        var remaped_data = data.data.map(function(d) {
            return {x: (d[0] - x_start) / (x_end - x_start), y: (d[1] - y_start) / (y_end - y_start)};
        });

        // create a canvas
        var canvas = document.createElement("canvas");
        canvas.width = 800;
        canvas.height = 400;
        document.getElementById("graph").appendChild(canvas);

        // draw the graph
        var ctx = canvas.getContext("2d");
        ctx.beginPath();
        ctx.moveTo(0, 400);
        remaped_data.forEach(function(d) {
            let x = d.x * 800;
            let y = 400 - d.y * 400;
            console.log(x, y);
            ctx.lineTo(x, y);
        });

        ctx.stroke();
    }

  </script>


</body>
</html>